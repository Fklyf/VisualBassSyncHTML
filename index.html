<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VisualBassSync HTML</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: black;
      color: white;
      font-family: sans-serif;
    }
    #brightnessDisplay {
      font-size: 56px;
      margin-bottom: 20px;
      text-align: center;
    }
    #connectBtn {
      font-size: 20px;
      padding: 10px 20px;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="brightnessDisplay">Brightness: 0</div>
  <button id="connectBtn">Connect Microphone</button>
  <div id="status">Waiting for microphone connection...</div>

  <script>
    // ----- CONSTANTS for Audio Processing -----
    const TARGET_FREQS = [35, 40, 45, 50, 55];  // Bass frequencies in Hz
    const BRIGHTNESS_GAIN = 1.6;                 // Boost factor for brightness
    const CONTROL_SENSITIVITY = 1.0;             // Multiplier for sensitivity
    const SMOOTHING_FACTOR = 0.9;                // For smoothing brightness changes
    const FFT_SIZE = 2048;                       // Higher FFT size for better resolution at low frequencies
    
    let audioContext, analyser, frequencyData;
    let smoothedBrightness = 0;  // Running smoothed brightness value
    let animationFrameId;
    
    // Initialize audio processing when the user clicks the button.
    async function initAudio() {
      try {
        // Request access to the microphone.
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        document.getElementById('status').textContent = 'Microphone connected';
        
        // Create the audio context and analyser node.
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = FFT_SIZE;
        analyser.smoothingTimeConstant = 0.8;
        
        // Connect the microphone stream to the analyser.
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        
        // Prepare the frequency data array.
        frequencyData = new Uint8Array(analyser.frequencyBinCount);
        
        // Start updating the brightness.
        updateBrightness();
      } catch (err) {
        console.error('Error accessing microphone:', err);
        document.getElementById('status').textContent = 'Error accessing microphone.';
      }
    }
    
    // Function to update brightness based on bass frequencies.
    function updateBrightness() {
      analyser.getByteFrequencyData(frequencyData);
      const sampleRate = audioContext.sampleRate;
      const resolution = sampleRate / analyser.fftSize; // Hz per FFT bin
      
      let sum = 0;
      TARGET_FREQS.forEach(freq => {
        let index = Math.round(freq / resolution);
        index = Math.min(index, frequencyData.length - 1);
        sum += frequencyData[index];
      });
      
      // Average amplitude across target bass frequencies.
      const avgAmplitude = sum / TARGET_FREQS.length;
      let brightness = (avgAmplitude * BRIGHTNESS_GAIN / 255) * CONTROL_SENSITIVITY;
      brightness = Math.min(brightness, 1.0);
      
      // Smooth the brightness transitions.
      smoothedBrightness = (smoothedBrightness * SMOOTHING_FACTOR) + (brightness * (1 - SMOOTHING_FACTOR));
      const brightnessValue = Math.floor(smoothedBrightness * 255);
      
      // Update the background color and display text.
      document.body.style.backgroundColor = `rgb(${brightnessValue}, ${brightnessValue}, ${brightnessValue})`;
      document.getElementById('brightnessDisplay').textContent = `Brightness: ${brightnessValue}`;
      
      // Continue the update loop.
      animationFrameId = requestAnimationFrame(updateBrightness);
    }
    
    // Set up the button to start audio processing.
    document.getElementById('connectBtn').addEventListener('click', function() {
      initAudio();
      this.style.display = 'none'; // Hide the button after connecting.
    });
  </script>
</body>
</html>
